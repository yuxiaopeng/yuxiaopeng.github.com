I"ñ<p><img src="/assets/images/2014/07/singleton.jpg" alt="" /></p>

<h3 id="1ä½•ä¸ºå•ä¾‹æ¨¡å¼singleton">1.ä½•ä¸ºå•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰</h3>
<p>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚
ä¸€ä¸ªå…¨å±€å˜é‡ä½¿å¾—ä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«è®¿é—®ï¼Œä½†å®ƒä¸èƒ½é˜²æ­¢å®ä¾‹åŒ–å¤šä¸ªå¯¹è±¡ã€‚ä¸€ä¸ªæ›´å¥½çš„åŠæ³•æ˜¯ï¼Œè®©ç±»è‡ªèº«è´Ÿè´£ä¿å­˜å®ƒçš„å”¯ä¸€å®ä¾‹ã€‚è¿™ä¸ªç±»å¯ä»¥ä¿è¯æ²¡æœ‰å…¶ä»–å®ä¾‹å¯ä»¥è¢«åˆ›å»ºï¼ˆé€šè¿‡æˆªå–åˆ›å»ºæ–°å¯¹è±¡çš„è¯·æ±‚ï¼‰ï¼Œå¹¶ä¸”å®ƒå¯ä»¥æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯Singletonæ¨¡å¼ã€‚</p>

<h3 id="2å¦‚ä½•å®ç°å•ä¾‹objective-c">2.å¦‚ä½•å®ç°å•ä¾‹ï¼ˆObjective-Cï¼‰</h3>
<p>å®ç°å•ä¾‹æ¨¡å¼çš„æ€è·¯æ˜¯ï¼šä¸€ä¸ªç±»èƒ½è¿”å›å¯¹è±¡ä¸€ä¸ªå¼•ç”¨(æ°¸è¿œæ˜¯åŒä¸€ä¸ª)å’Œä¸€ä¸ªè·å¾—è¯¥å®ä¾‹çš„æ–¹æ³•ï¼ˆå¿…é¡»æ˜¯é™æ€æ–¹æ³•ï¼‰ï¼›å½“æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå¦‚æœç±»æŒæœ‰çš„å¼•ç”¨ä¸ä¸ºç©ºå°±è¿”å›è¿™ä¸ªå¼•ç”¨ï¼Œå¦‚æœç±»ä¿æŒçš„å¼•ç”¨ä¸ºç©ºå°±åˆ›å»ºè¯¥ç±»çš„å®ä¾‹å¹¶å°†å®ä¾‹çš„å¼•ç”¨èµ‹äºˆè¯¥ç±»ä¿æŒçš„å¼•ç”¨ï¼›åŒæ—¶æˆ‘ä»¬è¿˜å°†è¯¥ç±»çš„æ„é€ å‡½æ•°å®šä¹‰ä¸ºç§æœ‰æ–¹æ³•ï¼Œè¿™æ ·å…¶ä»–å¤„çš„ä»£ç å°±æ— æ³•é€šè¿‡è°ƒç”¨è¯¥ç±»çš„æ„é€ å‡½æ•°æ¥å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ï¼Œåªæœ‰é€šè¿‡è¯¥ç±»æä¾›çš„é™æ€æ–¹æ³•æ¥å¾—åˆ°è¯¥ç±»çš„å”¯ä¸€å®ä¾‹ã€‚</p>

<p>åœ¨Objective-Cä¸­è¦å®ç°ä¸€ä¸ªå•ä¾‹éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p>

<ul>
  <li>åœ¨å•ä¾‹ç±»ä¸­å£°æ˜ä¸€ä¸ªå•ä¾‹ç±»çš„é™æ€å®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–ä¸ºnilï¼›</li>
  <li>åœ¨å•ä¾‹ç±»ä¸­å®ç°ä¸€ä¸ªç±»å·¥å‚æ–¹æ³•ï¼ˆæ–¹æ³•åç±»ä¼¼â€œsharedInstanceâ€ æˆ–è€…â€œsharedManagerâ€ï¼‰ï¼Œå½“å”¯ä¸€å®ä¾‹ä¸ºnilæ—¶é¦–å…ˆåˆ›å»ºå†è¿”å›è¿™ä¸ªå”¯ä¸€å®ä¾‹ï¼Œå¦‚æœå”¯ä¸€å®ä¾‹å·²ç»åˆ›å»ºåˆ™ç›´æ¥è¿”å›è¿™ä¸ªå”¯ä¸€å®ä¾‹ï¼›</li>
  <li>è¦†ç›– <code>allocWithZone:</code> æ–¹æ³•ï¼Œä»¥é˜²æ­¢å¤åˆ¶ç”Ÿæˆå®ä¾‹å‰¯æœ¬ï¼Œè€Œåªç”Ÿæˆè¿™ä¸ªå…±äº«çš„å”¯ä¸€å®ä¾‹ï¼›</li>
  <li>è¦†ç›– <code>release</code>ï¼Œ <code>retain</code>ï¼Œ <code>retainCount</code>ï¼Œ <code>autorelease</code> å†…å­˜ç®¡ç†æ–¹æ³•ï¼Œå…¶ä¸­åœ¨retainå’Œautoreleaseä»€ä¹ˆéƒ½ä¸åšåªæ˜¯è¿”å›è‡ªå·±ï¼Œreleaseçš„æ—¶å€™ä»€ä¹ˆéƒ½ä¸åšï¼Œå°†retainCountè®¾ä¸ºNSUIntegerçš„æå¤§å€¼ã€‚</li>
</ul>

<pre><code>/* Singleton.h */
#import &lt;Foundation/Foundation&gt;

@interface Singleton : NSObject
+ (Singleton *)instance;
@end

/* Singleton.m */
#import "Singleton.h"
static Singleton *instance = nil;

@implementation Singleton

+ (Singleton *)instance {
    if (!instance) {
        instance = [[super allocWithZone:NULL] init];
    }
    return instance;
}

+ (id)allocWithZone:(NSZone *)zone {
    return [self instance];
}

- (id)copyWithZone:(NSZone *)zone {
    return self;
}

- (id)init {
    if (instance) {
        return instance;
    }
    self = [super init];
    return self;
}

- (id)retain {
    return self;
}

- (oneway void)release {
    // Do nothing
}

- (id)autorelease {
    return self;
}

- (NSUInteger)retainCount {
    return NSUIntegerMax;
}

@end
</code></pre>

<p>è¿™æ˜¯ä¸€ç§å¾ˆæ ‡å‡†çš„Singletonå®ç°ï¼Œä¸è¿‡è¿™ç§å®ç°å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<font color="red">æ³¨ï¼š</font>
<p>å•ä¾‹æ¨¡å¼åœ¨å¤šçº¿ç¨‹çš„åº”ç”¨åœºåˆä¸‹å¿…é¡»å°å¿ƒä½¿ç”¨ã€‚å¦‚æœå½“å”¯ä¸€å®ä¾‹å°šæœªåˆ›å»ºæ—¶ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨åˆ›å»ºæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä»¬åŒæ—¶æ²¡æœ‰æ£€æµ‹åˆ°å”¯ä¸€å®ä¾‹çš„å­˜åœ¨ï¼Œä»è€ŒåŒæ—¶å„è‡ªåˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ ·å°±æœ‰ä¸¤ä¸ªå®ä¾‹è¢«æ„é€ å‡ºæ¥ï¼Œä»è€Œè¿åäº†å•ä¾‹æ¨¡å¼ä¸­å®ä¾‹å”¯ä¸€çš„åŸåˆ™ã€‚ è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•æ˜¯ä¸ºæŒ‡ç¤ºç±»æ˜¯å¦å·²ç»å®ä¾‹åŒ–çš„å˜é‡æä¾›ä¸€ä¸ªäº’æ–¥é”(è™½ç„¶è¿™æ ·ä¼šé™ä½æ•ˆç‡)ã€‚</p>

<p>åŠ å…¥çº¿ç¨‹å®‰å…¨çš„å•ä¾‹å®ç°ï¼š</p>

<pre><code>/* Singleton.h */
#import &lt;Foundation/Foundation&gt;

@interface Singleton : NSObject
+ (Singleton *)instance;
@end

/* Singleton.m */
#import "Singleton.h"
static Singleton *instance = nil;

@implementation Singleton

+ (Singleton *)instance {
    @synchronized(self) {
    	if (!instance) {
        	instance = [[super allocWithZone:NULL] init];
    	}
    }
    return instance;
}

+ (id)allocWithZone:(NSZone *)zone {
	 @synchronized(self) {  
     	return [self instance];
     }
}

- (id)copyWithZone:(NSZone *)zone {
    return self;
}

- (id)init {
    if (instance) {
        return instance;
    }
    self = [super init];
    return self;
}

- (id)retain {
    return self;
}

- (oneway void)release {
    // Do nothing
}

- (id)autorelease {
    return self;
}

- (NSUInteger)retainCount {
    return NSUIntegerMax;
}

@end
</code></pre>
<p>è¿™æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å•ä¾‹å®ç°ï¼Œä½†ä»¥ä¸Šä¸¤ç§å®ç°æ–¹å¼éƒ½æ˜¯æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„æ–¹å¼ï¼ŒiOS5ä¹‹åARCæŠ€æœ¯è¢«å¼•å…¥å¹¶æ™®éè¢«ä½¿ç”¨ï¼Œä¸‹é¢ç»™å‡ºç»“åˆGCDå®ç°ARCå•ä¾‹ï¼š</p>

<pre><code>#import &lt;Foundation/Foundation.h&gt;

@interface Singleton : NSObject

+(instancetype) sharedInstance;

@end

#import "MySingleton.h"

@implementation Singleton

+(instancetype) sharedInstance {
    static dispatch_once_t pred;
    static id shared = nil;
    dispatch_once(&amp;pred, ^{
        shared = [[super alloc] initUniqueInstance];
    });
    return shared;
}

-(instancetype) initUniqueInstance {
    return [super init];
}

@end
</code></pre>
<p>ä½¿ç”¨block <code>dispatch_once</code>ï¼Œæ­£å¦‚å…¶åç§°æ‰€æš—ç¤ºçš„ï¼Œåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…ï¼Œè¿™æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Œè¿™å°†ç¡®ä¿ä»…åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¹Ÿæ˜¯å¿«é€Ÿå’Œçº¿ç¨‹å®‰å…¨çš„ï¼šä¸éœ€è¦æ£€æŸ¥<code>synchronized</code>æˆ–<code>nil</code>ã€‚ä»¥ä¸Šå°±æ˜¯ARCä¸‹ç»“åˆGCDçš„ä¸€ä¸ªå•ä¾‹çš„ä»£ç ã€‚</p>

<p>å†è¿›ä¸€æ­¥ï¼Œè¿˜å¯ä»¥å†™ä¸€ä¸ªæ–¹ä¾¿è°ƒç”¨çš„å®ï¼Œå¦‚ä¸‹ï¼š</p>

<pre><code>+ (id)sharedInstance
{
  DEFINE_SHARED_INSTANCE_USING_BLOCK(^{
    return [[self alloc] init];
  });
}
</code></pre>

<h3 id="3åº”ç”¨cocoaä¸­çš„singleton">3.åº”ç”¨ï¼ˆCocoaä¸­çš„Singletonï¼‰</h3>
<p>åœ¨Cocoaæ¡†æ¶ä¸­ï¼Œæœ‰è®¸å¤šå•ä¾‹æ¨¡å¼çš„åº”ç”¨ï¼Œä¾‹å¦‚ï¼šNSFileManagerï¼ŒNSWorkspaceã€‚è€ŒUIKitæ¡†æ¶ä¸­ï¼ŒåŒæ ·ä¸ä¹å•ä¾‹æ¨¡å¼çš„åº”ç”¨ï¼Œä¾‹å¦‚ï¼šUIApplicationå’ŒUIAccelerometerã€‚æŒ‰ç…§æƒ¯ä¾‹ï¼Œè¿™äº›å•ä¾‹ç±»éƒ½æ˜¯é€šè¿‡å½¢å¦‚sharedClassTypeçš„å·¥å‚æ–¹æ³•è¿”å›ä¸€ä¸ªå…±äº«å®ä¾‹ã€‚Cocoaæ¡†æ¶çš„ä¾‹å­æ˜¯<code>sharedFileManager</code>ï¼Œ<code>sharedColorPanel</code>å’Œ<code>sharedWorkspace</code>ã€‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„<code>[NSUserDefaults standardUserDefaults]</code>ï¼Œ<code>[UIScreen mainScreen]</code> ä¹Ÿæ˜¯å•ä¾‹çš„ä¸¤ä¸ªåº”ç”¨ã€‚</p>

<p>å‚è€ƒï¼š  <br />
<a href="http://lukeredpath.co.uk/blog/2011/07/01/a-note-on-objective-c-singletons/"><code>A note on Objective-C singletons</code></a>  <br />
<a href="https://developer.apple.com/library/mac/documentation/General/Conceptual/DevPedia-CocoaCore/Singleton.html"><code>Singleton of Cocoa Core Competencies</code></a>  <br />
<a href="https://developer.apple.com/legacy/library/documentation/Cocoa/Conceptual/CocoaFundamentals/CocoaObjects/CocoaObjects.html#//apple_ref/doc/uid/TP40002974-CH4-SW32"><code>Creating a Singleton Instance</code></a>  <br />
<a href="http://www.galloway.me.uk/tutorials/singleton-classes/"><code>Singletons in Objective-C</code></a>  <br />
<a href="http://stackoverflow.com/questions/7997594/singleton-with-arc"><code>Singleton with ARC</code></a>  <br />
<a href="http://zh.wikipedia.org/zh/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><code>å•ä¾‹æ¨¡å¼</code></a></p>

:ET